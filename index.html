<html>
    <head>
        <meta charset="utf-8">
        <title>Import webrtc-internals dumps</title>
        <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
        <!-- highcharts is used under the terms of 
            http://shop.highsoft.com/faq/non-commercial
        -->
        <script src="//code.highcharts.com/highcharts.js"></script>

        <script>
function doImport(evt) {
  event.target.disabled = 'disabled';
  var files = evt.target.files;
  var reader = new FileReader();
  reader.onload = (function(file) {
    return function(e) {
      thelog = JSON.parse(e.target.result);
      importUpdatesAndStats(thelog);
    };
  })(files[0]);
  reader.readAsText(files[0]);
}

function importUpdatesAndStats(data) {
    var connection;
    var connid, reportname, statname;

    /*
    // first, display the updateLog
    for (connid in data) {
        connection = thelog[connid];
        connection.pid = connid.split("-")[0]
                connection.lid = connid.split("-")[1]
                connection.rid = 1; // can not be reconstructed
        connection.log = connection.updateLog;
        delete connection.updateLog;
        connectiondata.push(connection);
    }
    updateAllPeerConnections(connectiondata);   
    delete connectiondata;
    */

    // then, update the stats displays
    for (connid in data.PeerConnections) {
        connection = data.PeerConnections[connid];
        var reportobj = {};
        for (reportname in connection.stats) { 
            var t = reportname.split("-");
            var comp = t.pop();
            var stat = t.join("-");
            if (!reportobj.hasOwnProperty(stat)) { 
                reportobj[stat] = [];
            }
            reportobj[stat].push([comp, JSON.parse(connection.stats[reportname].values)]);
        }
        console.log(reportobj);
        for (reportname in reportobj) {
            var series = [];
            var reports = reportobj[reportname];
            reports.forEach(function (report) {
                if (typeof(report[1][0]) !== 'number') return;
                if (report[0] === 'bytesReceived' || report[0] === 'bytesSent') return;
                if (report[0] === 'packetsReceived' || report[0] === 'packetsSent') return;
                if (report[0] === 'googCaptureStartNtpTimeMs') return;
                series.push({
                    name: report[0],
                    data: report[1]
                });
            });
            if (series.length > 0) {
                var d = document.createElement('div');
                d.id = 'chart_' + Date.now();
                document.getElementById('container').appendChild(d);
                new Highcharts.Chart({
                    title: {
                        text: reportname
                    },
                    /*
                    xAxis: {
                        type: 'datetime'
                    },
                    yAxis: {
                        min: 0
                    },
                    */
                    chart: {
                        zoomType: 'x',
                        renderTo : d.id
                    },
                    series: series
                });
            }
        }
    }
}
        </script>
    </head>
    <body>
        <form><input type="file" onchange="doImport(event)"></form>
        <div id="container" style="min-width: 95%; height: 400px; margin: 0 auto">
        </div>
    </body>
</html>
