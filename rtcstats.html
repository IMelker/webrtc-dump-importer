<html>
    <head>
        <meta charset="utf-8">
        <title>Import webrtc-internals dumps</title>
        <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
        <!-- highcharts is used under the terms of
            http://shop.highsoft.com/faq/non-commercial
        -->
        <script src="//code.highcharts.com/highcharts.js"></script>
        <style>
            body, body svg text {
                font-family: monospace;
            }
            details[open] pre {
                padding-left: 10px;
                padding-bottom: 10px;
            }
            details[open] summary {
                color: blue;
            }
            details.host summary:after {
                content: ' (host)';
            }
            details.relay summary:after {
                content: ' (relay)';
            }
            details.srflx summary:after {
                content: ' (srflx)'
            }
        </style>

        <script>
function doImport(evt) {
  event.target.disabled = 'disabled';
  var files = evt.target.files;
  var reader = new FileReader();
  reader.onload = (function(file) {
    return function(e) {
      thelog = JSON.parse(e.target.result);
      importUpdatesAndStats(thelog);
    };
  })(files[0]);
  reader.readAsText(files[0]);
}

function createContainers(connid, url) {
    var container = document.createElement('div');
    container.style.margin = '10px';

    // show state transitions, like in https://webrtc.github.io/samples/src/content/peerconnection/states
    var signalingState = document.createElement('div');
    signalingState.id = 'signalingstate_' + connid;
    signalingState.textContent = 'Signaling state:';
    container.appendChild(signalingState);
    var iceConnectionState = document.createElement('div');
    iceConnectionState.id = 'iceconnectionstate_' + connid;
    iceConnectionState.textContent = 'ICE connection state:';
    container.appendChild(iceConnectionState);

    var table = document.createElement('table');
    var head = document.createElement('tr');
    table.appendChild(head);

    var el;
    el = document.createElement('th');
    el.innerText = 'connection ' + connid;
    head.appendChild(el);

    el = document.createElement('th');
    el.innerText = url;
    head.appendChild(el);

    container.appendChild(table);

    containers[connid] = {
        updateLog: table,
        iceConnectionState: iceConnectionState,
        signalingState: signalingState
    };

    return container;
}

function processTraceEvent(table, event) {
    var row = document.createElement('tr');
    el = document.createElement('td');
    el.setAttribute('nowrap', '');
    el.innerText = event.time;
    row.appendChild(el);

    // recreate the HTML of webrtc-internals
    var details = document.createElement('details');
    el = document.createElement('summary');
    el.innerText = event.type;
    details.appendChild(el);

    el = document.createElement('pre');
    el.innerText = JSON.stringify(event.value, null, ' ');
    details.appendChild(el);

    el = document.createElement('td');
    el.appendChild(details);

    row.appendChild(el);

    // guess what, if the event type contains 'Failure' one could use css to highlight it
    if (event.type.indexOf('Failure') !== -1) {
        row.style.backgroundColor = 'red';
    }
    if (event.type === 'iceConnectionStateChange') {
        switch(event.value) {
        case 'ICEConnectionStateConnected':
        case 'ICEConnectionStateCompleted':
            row.style.backgroundColor = 'green';
            break;
        case 'ICEConnectionStateFailed':
            row.style.backgroundColor = 'red';
            break;
        }
    }

    if (event.type === 'onIceCandidate' || event.type === 'addIceCandidate') {
        if (event.value.candidate) {
            var parts = event.value.candidate.trim().split(' ');
            if (parts && parts.length >= 9 && parts[7] === 'typ') {
                details.classList.add(parts[8]);
            }
        }
    }
    table.appendChild(row);
}

var graphs = {};
var containers = {};
function importUpdatesAndStats(data) {
    var connection;
    var connid, reportname, statname;

    for (connid in data.peerConnections) {
        connection = data.peerConnections[connid];
        var container = createContainers(connid, data.url);
        document.getElementById('tables').appendChild(container);

        for (var i = 0; i < connection.length; i++) {
            if (connection[i].type !== 'getStats' && connection[i].type !== 'getstats') {
                processTraceEvent(containers[connid].updateLog, connection[i]);
            }
        }
    }

    // then, update the stats displays
    for (connid in data.peerConnections) {
        connection = data.peerConnections[connid];
        var series = {};
        for (var i = 0; i < connection.length; i++) {
            if (connection[i].type === 'getStats' || connection[i].type === 'getstats') {
                var stats = connection[i].value;
                Object.keys(stats).forEach(function(id) {
                    if (stats[id].type === 'localcandidate' || stats[id].type === 'remotecandidate') return;
                    Object.keys(stats[id]).forEach(function(name) {
                        if (name === 'timestamp') return;
                        if (name === 'ssrc') return;
                        if (name === 'googMinPlayoutDelayMs') stats[id][name] = parseInt(stats[id][name], 10);
                        if (typeof stats[id][name] === 'number') {
                            if (!series[id]) series[id] = {};
                            if (!series[id][name]) series[id][name] = [];
                            series[id][name].push(stats[id][name]);
                        }
                    });
                });
            }
        }
        graphs[connid] = {};
        var reportobj = {};
        for (reportname in series) {
            /*
                series.push({
                    name: report[0],
                    data: report[1]
                });
                */

            var d = document.createElement('div');
            d.id = 'chart_' + Date.now();
            document.getElementById('container').appendChild(d);
            console.log(reportname, series[reportname]);
            var da = [];
            Object.keys(series[reportname]).forEach(function(name) {
                da.push({
                    name: name,
                    data: series[reportname][name]
                });
            });
            var graph = new Highcharts.Chart({
                title: {
                    text: connid + ' ' + reportname
                },
                /*
                xAxis: {
                    type: 'datetime'
                },
                yAxis: {
                    min: 0
                },
                */
                chart: {
                    zoomType: 'x',
                    renderTo : d.id
                },
                series: da
            });
            graphs[connid][reportname] = graph;
        }
    }
}
        </script>
    </head>
    <body>
        <form><input type="file" onchange="doImport(event)"></form>
        <div id="tables">
        </div>
        <div id="container" style="min-width: 95%; height: 400px; margin: 0 auto">
        </div>
    </body>
</html>
